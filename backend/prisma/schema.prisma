generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// User Management
// ============================================

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  password     String
  name         String
  role         Role     @default(viewer)
  loginBarcode String?  @unique @map("login_barcode") // UUID for barcode login (admin & manager only)
  createdById  Int?     @map("created_by_id") // tracks which admin created this user
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  createdBy       User?          @relation("UserCreator", fields: [createdById], references: [id])
  createdUsers    User[]         @relation("UserCreator")
  inventoryEvents InventoryEvent[]
  requestsCreated Request[]      @relation("RequestCreator")
  roleRequests    RoleRequest[]  @relation("RoleRequester")
  roleDecisions   RoleRequest[]  @relation("RoleDecider")

  @@map("users")
}

// ============================================
// Role Promotion Requests
// ============================================

model RoleRequest {
  id            Int               @id @default(autoincrement())
  userId        Int
  requestedRole Role
  status        RoleRequestStatus @default(PENDING)
  reason        String?           @db.Text
  decidedById   Int?              @map("decided_by_id")
  createdAt     DateTime          @default(now())
  decidedAt     DateTime?

  user      User  @relation("RoleRequester", fields: [userId], references: [id], onDelete: Cascade)
  decidedBy User? @relation("RoleDecider", fields: [decidedById], references: [id])

  @@map("role_requests")
}

enum RoleRequestStatus {
  PENDING
  APPROVED
  DENIED
}

enum Role {
  admin
  manager
  fulfillment
  viewer
}

// ============================================
// Parts Catalog
// ============================================

model Part {
  id          Int            @id @default(autoincrement())
  sku         String         @unique
  name        String
  description String?        @db.Text
  condition   PartCondition  @default(UNKNOWN)
  minStock    Int            @default(5) @map("min_stock") // Low stock threshold
  costCents   Int?           @map("cost_cents") // Cost per unit in cents (e.g., 1999 = $19.99)
  barcodeData String?        @db.Text @map("barcode_data")
  skuDecoded  String?        @db.Text @map("sku_decoded")
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  fitments           PartFitment[]
  interchangeMembers InterchangeGroupMember[]
  inventoryEvents    InventoryEvent[]
  requestItems       RequestItem[]
  images             PartImage[]

  @@map("parts")
}

model PartImage {
  id        Int      @id @default(autoincrement())
  partId    Int      @map("part_id")
  filename  String   // Original filename
  mimeType  String   @map("mime_type") // image/jpeg, image/png, etc.
  data      String   @db.LongText // Base64 encoded image data
  isPrimary Boolean  @default(false) @map("is_primary") // Primary/thumbnail image
  createdAt DateTime @default(now()) @map("created_at")

  part Part @relation(fields: [partId], references: [id], onDelete: Cascade)

  @@index([partId])
  @@map("part_images")
}

enum PartCondition {
  NEW         // Brand new, never installed
  EXCELLENT   // Used, like new condition
  GOOD        // Used, normal wear, fully functional
  FAIR        // Used, noticeable wear but functional
  POOR        // Heavy wear, may need repair
  CORE        // For rebuild/exchange programs
  SALVAGE     // Damaged, for parts only
  UNKNOWN     // Condition not assessed
}

// ============================================
// Vehicles (Year >= 2000 enforced in app layer)
// ============================================

model Vehicle {
  id        Int      @id @default(autoincrement())
  year      Int      // Constraint: year >= 2000 enforced in application
  make      String
  model     String
  trim      String?
  createdAt DateTime @default(now())

  fitments PartFitment[]

  @@unique([year, make, model, trim])
  @@map("vehicles")
}

// ============================================
// Part Fitments (Many-to-Many: Part <-> Vehicle)
// ============================================

model PartFitment {
  id        Int      @id @default(autoincrement())
  partId    Int
  vehicleId Int
  createdAt DateTime @default(now())

  part    Part    @relation(fields: [partId], references: [id], onDelete: Cascade)
  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@unique([partId, vehicleId])
  @@map("part_fitments")
}

// ============================================
// Interchangeability Groups
// ============================================

model InterchangeGroup {
  id          Int      @id @default(autoincrement())
  name        String
  description String?  @db.Text
  createdAt   DateTime @default(now())

  members InterchangeGroupMember[]

  @@map("interchange_groups")
}

model InterchangeGroupMember {
  id        Int      @id @default(autoincrement())
  groupId   Int
  partId    Int
  createdAt DateTime @default(now())

  group InterchangeGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  part  Part             @relation(fields: [partId], references: [id], onDelete: Cascade)

  @@unique([groupId, partId])
  @@map("interchange_group_members")
}

// ============================================
// Locations (Warehouses, Bins, etc.)
// ============================================

model Location {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  createdAt DateTime @default(now())

  inventoryEvents InventoryEvent[]
  requestItems    RequestItem[]

  @@map("locations")
}

// ============================================
// Inventory Events (Append-Only Ledger)
// Source of truth for inventory quantities
// ============================================

model InventoryEvent {
  id         Int                @id @default(autoincrement())
  type       InventoryEventType
  qtyDelta   Int                // positive = increase, negative = decrease
  partId     Int
  locationId Int
  reason     String?            @db.Text
  requestId  Int?               // links FULFILL events to requests
  createdBy  Int
  createdAt  DateTime           @default(now())

  part     Part     @relation(fields: [partId], references: [id])
  location Location @relation(fields: [locationId], references: [id])
  user     User     @relation(fields: [createdBy], references: [id])
  request  Request? @relation(fields: [requestId], references: [id])

  @@index([partId, locationId])
  @@index([createdAt])
  @@map("inventory_events")
}

enum InventoryEventType {
  RECEIVE
  FULFILL
  RETURN
  CORRECTION
}

// ============================================
// Requests & Request Items
// ============================================

model Request {
  id          Int           @id @default(autoincrement())
  status      RequestStatus @default(PENDING)
  notes       String?       @db.Text
  createdBy   Int
  approvedBy  Int?
  fulfilledBy Int?
  createdAt   DateTime      @default(now())
  approvedAt  DateTime?
  fulfilledAt DateTime?

  creator         User             @relation("RequestCreator", fields: [createdBy], references: [id])
  items           RequestItem[]
  inventoryEvents InventoryEvent[]

  @@index([status])
  @@index([createdAt])
  @@map("requests")
}

enum RequestStatus {
  PENDING
  APPROVED
  FULFILLED
  CANCELLED
}

// ============================================
// SKU / Barcode Code Tables
// ============================================

model MakeCode {
  id   Int    @id @default(autoincrement())
  make String @unique
  code String @db.Char(2) @unique

  @@map("make_codes")
}

model ModelCode {
  id    Int    @id @default(autoincrement())
  make  String
  model String
  code  String @db.Char(3)

  @@unique([make, model])
  @@map("model_codes")
}

model SystemCode {
  id          Int    @id @default(autoincrement())
  name        String
  code        String @db.Char(2) @unique
  description String? @db.Text

  @@map("system_codes")
}

model ComponentCode {
  id         Int    @id @default(autoincrement())
  systemCode String @db.Char(2) @map("system_code")
  name       String
  code       String @db.Char(2)

  @@unique([systemCode, code])
  @@map("component_codes")
}

model RequestItem {
  id           Int  @id @default(autoincrement())
  requestId    Int
  partId       Int
  qtyRequested Int
  qtyFulfilled Int  @default(0)
  locationId   Int? // target location for fulfillment

  request  Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)
  part     Part     @relation(fields: [partId], references: [id])
  location Location? @relation(fields: [locationId], references: [id])

  @@map("request_items")
}

// ============================================
// Audit Log (System-wide activity tracking)
// ============================================

model AuditLog {
  id          Int      @id @default(autoincrement())
  action      String   // CREATE, UPDATE, DELETE, LOGIN, etc.
  entityType  String   @map("entity_type") // Part, User, Request, etc.
  entityId    Int?     @map("entity_id")
  entityName  String?  @map("entity_name") // Human-readable identifier
  userId      Int      @map("user_id")
  userName    String   @map("user_name")
  details     String?  @db.Text // JSON with old/new values or extra context
  ipAddress   String?  @map("ip_address")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}
